---
description: Before deploy or push to main, run tests and remind user of make smoke / make pre-deploy
alwaysApply: false
---

# Pre-deploy gate

When the user says **"deploy"**, **"push to main"**, **"deploy to production"**, or asks to run the deploy script:

1. **Run tests first (if possible):**
   - If `.env.local` exists: run `make smoke` (or at least unit tests for changed areas).
   - Otherwise: run unit tests for any changed paths, e.g. `pytest tests/unit/test_risk_manager.py tests/unit/test_runner_capital_fixes.py tests/unit/test_tp_placement_invariant.py` when risk/execution changed.
2. **Remind explicitly:** Before executing deploy (or handing the user the deploy command), say: "Pre-deploy: run `make smoke` (or `make pre-deploy`) before deploy if you have .env.local."
3. **Do not skip:** Never suggest `make deploy-quick` or `--skip-tests` without the user having explicitly asked for a quick deploy; prefer full `make deploy` so smoke runs.
