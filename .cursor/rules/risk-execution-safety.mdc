---
description: When editing risk or execution code, consider invariants, run tests, and preserve binding/margin/venue semantics
globs: src/risk/**/*.py, src/execution/**/*.py, src/live/protection_ops.py
alwaysApply: false
---

# Risk & Execution Safety

When editing files under `src/risk/`, `src/execution/`, or `src/live/protection_ops.py`:

1. **Invariants:** Consider position/margin/order invariants (e.g. sum(tp_qtys) ≤ position_qty; tp_qty ≥ venue_min or skip; margin caps; single TP placement path). Use the **invariant-first-review** skill for PRs/diffs on these areas.
2. **Tests:** After changes, run the relevant unit tests (e.g. `pytest tests/unit/test_risk_manager.py tests/unit/test_runner_capital_fixes.py tests/unit/test_tp_placement_invariant.py` for risk/execution/TP).
3. **Semantics:** Risk: binding constraint (risk_sizing, single_margin, min_notional_reject, etc.), utilisation boost only when `sizing_method == "leverage_based"`. Execution: TP placement goes through `update_protective_orders` (contract sizing, venue min); do not reintroduce notional-only or dust TP paths.
4. **Config:** If changing risk or auction config, check `config.yaml` comments and `FORAI.md` for binding constraints and utilisation.
