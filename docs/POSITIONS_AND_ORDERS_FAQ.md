# Positions Closed & Open Orders – FAQ

## “The system closed all positions – intentional or bug?”

**“All positions closed”** means the **exchange** reports 0 open positions (you see this as “Active Portfolio: 0 positions” in logs).

### When we **intentionally** close

1. **Stop loss hit** – Price crosses stop → we send a reduce‑only market close.
2. **Premise invalidation** – Bias flips (e.g. long vs EMA200) → we close that position.
3. **Targets hit** – TP1/TP2 partial closes, final target full close.
4. **Kill switch** – Emergency mode flattens **all** positions.
5. **Replacement** – We close one symbol to open a better one (opportunity‑cost replacement).
6. **Reversal** – We close before opening the opposite side.

We only **send** close orders in these cases. The rest is the exchange (and possibly manual) closing.

### When it **looks** like we closed but we didn’t

- **Reconciliation “zombies”**  
  We have a position in **our DB**, exchange says we don’t. We **delete it from our DB** only. We do **not** send a close order – the position was already gone on the exchange (e.g. stop filled, manual close, outside closure).

- **Registry “orphans”**  
  V2 registry has a position, exchange doesn’t. We **mark** it orphaned. We don’t place a new close; we may later flatten if we choose to “fix” that symbol on exchange.

So “all closed” can be:

- Us closing via stops/targets/premise/kill/replacement/reversal, or  
- Exchange already flat, and we’re just updating our state (zombie delete / orphan mark).

### How to tell which it was

1. **Logs**  
   Search for: `Exit initiated`, `CLOSE`, `Premise Invalidation`, `Kill switch`, `Reconciliation`, `ZOMBIE`, `ORPHAN`, `FLATTEN`, `replace`, `reversal`.

2. **Exchange history**  
   Check Kraken Futures fills / order history: were those positions closed by **our** orders (same `clientOrderId` / mapping we use) or by something else (e.g. stop‑market fills, manual)?

3. **Kill switch**  
   If it was activated, we explicitly close all positions. Check kill‑switch state and logs.

---

## “The open orders that remain – are they from new signals?”

**Not necessarily.** The “recovered” open orders (e.g. 13) are **all** open orders we sync from the exchange. They can be:

| Type | Meaning |
|------|--------|
| **Entry limits** | From **new** signals, waiting to fill. |
| **Stops** | Protective stops. If there are **no** positions, these are **stale** (left over from positions we already closed – we closed at market but didn’t cancel the stop). |
| **Take‑profits** | Same idea: can be **stale** if the position was closed another way. |

So:

- **With 0 positions**, any remaining **stops** or **TPs** are typically **stale** (bug‑class: we should cancel them when we close the position).
- **Entry** orders are from **new** signals (or older unfilled limits we’re still tracking).

### How to inspect your current open orders

```bash
make audit          # Read‑only: breakdown by type, per‑symbol, multiple stops
make audit-cancel   # Same + cancel redundant stops (keeps most protective per symbol)
```

Use `make audit` first. It prints:

- Counts **by type** (stop, take_profit, limit, etc.).
- **Per‑symbol** counts (and how many stops per symbol).
- **Multiple stops per symbol** (suspicious; usually redundant).

That tells you whether the remaining orders are mostly **stops/TPs** (likely stale) vs **limits** (often new‑signal entries).

---

## “We see signals (LONG/SHORT) but no trades – why?”

Signals are generated by the SMC engine and written to `DECISION_TRACE`. Orders are placed only when **all** of the following hold:

1. **Signal is tradable**  
   We only call the execution path when the symbol has a **futures** ticker (`is_tradable = has_futures`). No futures → we never attempt to trade that symbol.

2. **Risk manager approves**  
   `RiskManager.validate_trade` must approve (position size, leverage, daily loss, basis, etc.). If not, we log **`Trade rejected by Risk Manager`** and return.

3. **State machine allows entry**  
   `PositionManagerV2.evaluate_entry` must **not** return `REJECT_ENTRY` (e.g. existing position, reversal rules). Otherwise we log **`Entry REJECTED by State Machine`** and return.

4. **No dry-run / kill-switch bypass**  
   `DRY_RUN` mainly affects sync/reconciliation. The **kill switch** bypasses all trading when active.

### How to check

| Check | What to do |
|-------|------------|
| **Risk rejections** | Search for `Trade rejected by Risk Manager` and `reasons=...`. |
| **State-machine rejections** | Search for `Entry REJECTED by State Machine` and `reason=...`. |
| **Ticker coverage** | Check `Coin processing status summary`: `symbols_with_ticker` (spot), `symbols_with_futures` (tradable). We need **futures** ticker to trade. Log "Signal skipped (no futures ticker)" = symbol has signal but no futures → not traded. |
| **Wrong symbol for exchange** | `Entry failed` / `Leverage setting failed ... does not have market symbol X/USD` meant we sent **spot** symbol to Kraken Futures. Orders use **futures** symbol (e.g. `X/USD:USD`). We now pass `order_symbol=futures_symbol` for entries. |

See also [CANDLE_DATA_AND_SUFFICIENT_COINS](CANDLE_DATA_AND_SUFFICIENT_COINS.md) for “only N coins sufficient” and ticker/backfill issues.

---

## "Positions open but no SL or TP – why?"

**Cause:** SL/TP are placed only **after** we confirm the **entry fill** via order-status updates. We never processed those updates, so we never ran the "place stop" follow-up.

1. **Order-status polling** – We now poll pending entry orders (e.g. every 12s), fetch status, and call `process_order_update`. When an entry is **filled**, we emit a `PLACE_STOP` action and place the stop (and optionally TPs) via the gateway.
2. **Futures symbol for stops** – Stops (and close/partial) use `position.futures_symbol` (e.g. `X/USD:USD`) when set, so Kraken Futures receives the correct symbol.

**Existing naked positions (e.g. 27+ with no SL/TP):** Those were opened **before** the poller existed. We never got fill events, so we never placed stops. **Going forward**, new entries will get SL/TP once the poller sees the fill. For **existing** naked positions, use the **place-missing-stops** tool:

```bash
make place-missing-stops              # Dry-run: list naked positions and would-be stops
make place-missing-stops-live         # Place stops (default 2% from entry)
make place-missing-stops STOP_PCT=1.5 # Use 1.5% distance (dry-run)
```

---

## Summary

| Question | Short answer |
|----------|--------------|
| **Closed all – intentional or bug?** | Could be either. Check logs (exit reasons, kill switch, reconciliation, flatten) and exchange history. “Zombie” / “orphan” handling does **not** send close orders. |
| **Remaining orders from new signals?** | Only **entry** orders are from new signals. Stops/TPs with **0** positions are usually **stale**; run `make audit` / `make audit-cancel` to verify and clean up. |
| **Signals but no trades?** | Confirm: futures ticker, risk approval, no state-machine reject, kill switch off. Check logs per table above. |
| **Positions open but no SL/TP?** | We now poll entry order status and place SL (and TP) after fill. Existing naked positions need manual stops or a place‑missing‑stops tool. |
