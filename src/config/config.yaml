# Configuration

## System
system:
  name: "Trading System V3"
  version: "3.0.0"
  dry_run: false  # Disable dry run to allow real trades

## Exchange Settings
exchange:
  name: "kraken"
  spot_markets:
    - "BTC/USD"
    - "ETH/USD"
  futures_markets:
    - "BTCUSD-PERP"
    - "ETHUSD-PERP"
  # Excluded from coin processing (analysis + trading loop). This is a hard block:
  # blocked symbols will not be analyzed and will never be opened as new trades.
  spot_ohlcv_blocklist:
    - "2Z/USD"
    - "ANIME/USD"
    - "USDT/USD"
    - "GBP/USD"
    - "EUR/USD"
    - "AUD/USD"
  use_futures_ohlcv_fallback: true   # Use futures OHLCV when spot unavailable (e.g. BadSymbol)
  # Credentials
  api_key: "${KRAKEN_API_KEY}"
  api_secret: "${KRAKEN_API_SECRET}"
  futures_api_key: "${KRAKEN_FUTURES_API_KEY}"
  futures_api_secret: "${KRAKEN_FUTURES_API_SECRET}"
  use_testnet: false

## Risk Management
risk:
  # Position sizing (leverage-based)
  risk_per_trade_pct: 0.03  # 3% of buying power per trade
  max_leverage: 10.0  # Maximum leverage allowed (hard cap)
  target_leverage: 7.0  # Target leverage for position sizing (5-10x range)

  # Sizing method: leverage_based = (Equity × Leverage × Risk%)
  sizing_method: "leverage_based"  # Options: fixed, kelly, volatility, kelly_volatility, leverage_based
  
  # Liquidation safety
  min_liquidation_buffer_pct: 0.35  # 35% minimum distance from liquidation price
  
  # Portfolio limits (CONSERVATIVE for live start)
  # Portfolio limits (Scaled for Multi-Asset)
  max_concurrent_positions: 25  # Allow up to 25 parallel trades
  daily_loss_limit_pct: 0.05  # 5% daily loss limit (Accommodates 10x active sizing)
  loss_streak_cooldown: 3  # Halt after 3 consecutive losses
  
  # Auction mode portfolio allocation
  auction_mode_enabled: true  # Enable auction-based portfolio allocation
  auction_max_positions: 25  # Maximum positions in portfolio
  auction_max_margin_util: 0.90  # Maximum margin utilization (90%)
  auction_max_per_cluster: 8  # Maximum positions per cluster (balanced for 25 positions)
  auction_max_per_symbol: 1  # Maximum positions per symbol
  auction_swap_threshold: 10.0  # Minimum score advantage to replace position
  auction_min_hold_minutes: 15  # Minimum hold time before position can be kicked
  auction_max_trades_per_cycle: 5  # Maximum total trades per cycle (anti-churn)
  auction_max_new_opens_per_cycle: 5  # Maximum new positions per cycle
  auction_max_closes_per_cycle: 5  # Maximum closes per cycle
  auction_entry_cost: 2.0  # Entry cost penalty in score points
  auction_exit_cost: 2.0  # Exit cost penalty in score points
  
  # Basis guards
  basis_max_pct: 0.0075  # 0.75% max spot-perp divergence for entry
  basis_max_post_pct: 0.0075  # Post-entry divergence limit (same as entry)
  
  # Cost-aware validation
  # Cost-aware validation
  max_fee_funding_rr_distortion_pct: 0.20  # Hard cap (allows 20% for tight stops)
  rr_distortion_strict_limit_pct: 0.10  # Strict cap for normal stops (>1.5%)
  tight_stop_threshold_pct: 0.015  # Definition of "tight stop" (1.5%)
  funding_cost_threshold_pct: 0.02  # Optional: block entries if projected funding > 2%

  # Kelly Criterion Settings (for kelly and kelly_volatility sizing)
  kelly_win_prob: 0.55  # 55% win rate assumption
  kelly_win_loss_ratio: 2.0  # Average winner is 2x average loser
  kelly_max_fraction: 0.30  # Cap at 30% of Kelly recommendation (safety)

  # Max risk per trade when using Kelly sizing
  max_risk_per_trade_entry_pct: 0.03  # Max 3% risk per trade (cap for Kelly)

  # Volatility sizing adjustments
  vol_sizing_atr_threshold_high: 1.5  # Reduce size if ATR > 1.5x average
  vol_sizing_atr_threshold_low: 0.5  # Increase size if ATR < 0.5x average
  vol_sizing_high_vol_penalty: 0.30  # -30% size in high volatility
  vol_sizing_low_vol_boost: 0.20  # +20% size in low volatility

  # Position size cap
  max_position_size_usd: 100000  # Max $100k notional per position

  # V2.1 Regime Risk
  tight_smc_cost_cap_bps: 25.0
  tight_smc_min_rr_multiple: 2.0
  tight_smc_avg_hold_hours: 6.0
  wide_structure_max_distortion_pct: 0.15
  wide_structure_avg_hold_hours: 36.0
  
  loss_streak_cooldown_tight: 3
  loss_streak_cooldown_wide: 5
  loss_streak_pause_minutes_tight: 120
  loss_streak_pause_minutes_wide: 90
  loss_streak_min_loss_bps: 20.0

## Strategy Parameters
strategy:
  # ============================================================
  # TIMEFRAME HIERARCHY - 4H DECISION AUTHORITY (LOCKED)
  # ============================================================
  # This configuration is LOCKED after backtest validation:
  # - 4H decision produces 78.9% win rate vs 69.1% on 1H
  # - 2.4x better PnL per trade, 60% lower drawdown
  # DO NOT change decision_timeframes without re-running paired comparison
  # ============================================================
  #
  # 1D: Regime filter only (EMA200 bias, risk on/off)
  # 4H: DECISION AUTHORITY - all SMC patterns (OB, FVG, BOS, ATR for stops)
  # 1H: Refinement only - ADX filter, swing point precision
  # 15m: Refinement only - entry timing
  regime_timeframes:
    - "1d"
  decision_timeframes:
    - "4h"  # LOCKED - do not change
  refinement_timeframes:
    - "1h"
    - "15m"
  # Legacy compatibility (deprecated - use hierarchy above)
  bias_timeframes:
    - "4h"
    - "1d"
  execution_timeframes:
    - "15m"
    - "1h"
  
  # Indicators
  ema_period: 200
  adx_period: 14
  adx_threshold: 25.0  # Minimum ADX for trend strength
  atr_period: 14
  atr_multiplier_stop: 1.5  # ATR multiplier for stop-loss buffer
  rsi_period: 14
  rsi_divergence_enabled: false  # Optional confirmation only
  
  # SMC Parameters
  orderblock_lookback: 50
  fvg_min_size_pct: 0.001  # 0.1% minimum gap size
  bos_confirmation_candles: 3
  
  # V2.3: Market Structure Change Confirmation (4H Decision Authority)
  # NOTE: Now uses 4H candles - 1 candle = 4 hours, 2 candles = 8 hours
  require_ms_change_confirmation: false  # Bypass for trend activity (original: true)
  ms_confirmation_candles: 1  # Base: 1 candle on 4H = 4 hours
  ms_confirmation_candles_high_vol: 2  # High volatility: 2 candles on 4H = 8 hours
  ms_reconfirmation_candles: 1  # Candles for reconfirmation (retrace)
  skip_reconfirmation_in_trends: true  # Enter immediately after MSS in trends

  # V2.3 Scoring & Regimes (Slightly relaxed)
  ema_neutral_zone_bps: 10.0
  min_score_tight_smc_aligned: 65.0  # Was 70.0
  min_score_tight_smc_neutral: 75.0
  min_score_wide_structure_aligned: 60.0  # Was 65.0
  min_score_wide_structure_neutral: 70.0
  fib_proximity_bps: 20.0
  
  # V2.3: Entry Zone Tolerance (Allows "near" OB/FVG entries)
  entry_zone_tolerance_pct: 0.02  # 2% buffer
  entry_zone_tolerance_adaptive: true  # Scale with ATR
  entry_zone_tolerance_atr_mult: 0.3  # ATR multiplier
  entry_zone_tolerance_score_penalty: -5  # Penalty for tolerance entries
  
  # Regime-specific stops (adjusted for 4H ATR - roughly halved since 4H ATR is ~2-3x larger)
  # tight_smc: Order Block / FVG entries with precise zones
  tight_smc_atr_stop_min: 0.15  # Was 0.3 on 1H ATR
  tight_smc_atr_stop_max: 0.30  # Was 0.6 on 1H ATR
  # wide_structure: BOS/Trend entries with wider invalidation
  wide_structure_atr_stop_min: 0.50  # Was 1.0 on 1H ATR
  wide_structure_atr_stop_max: 0.60  # Was 1.2 on 1H ATR

## Execution Settings
execution:
  # Price conversion
  use_mark_price: true  # Always true for safety-critical operations
  
  # Order settings
  default_order_type: "limit"
  slippage_tolerance_pct: 0.001  # 0.1%
  order_timeout_seconds: 120  # 2 minutes for limit orders to fill
  order_price_invalidation_pct: 0.03  # Cancel if price moves 3% away from order
  max_retries: 3
  retry_backoff_seconds: 2
  
  # Pyramiding
  pyramiding_enabled: false  # Default: no adding to positions

  # Hard entry blocks (NEW entries only; reduce-only exits still allowed)
  entry_blocklist_spot_symbols:
    - "USDT/USD"
  entry_blocklist_bases:
    - "USDT"
  
  # TP Backfill / Reconciliation
  tp_backfill_enabled: true  # Enable TP backfill reconciliation
  tp_backfill_cooldown_minutes: 10  # Cooldown between backfill attempts per symbol
  tp_price_tolerance: 0.002  # TP price tolerance (0.2%)
  min_tp_distance_pct: 0.003  # Minimum TP distance from current price (0.3%)
  min_tp_orders_expected: 2  # Minimum expected TP orders in ladder
  min_hold_seconds: 30  # Minimum hold time before backfill (avoid racing fills)
  require_sl_for_tp_backfill: true  # Re-enabled after SL fix verified - all positions now protected

## Multi-TP Configuration (V2)
multi_tp:
  enabled: true
  tp1_r_multiple: 1.0   # Close 40% at 1R
  tp1_close_pct: 0.40
  tp2_r_multiple: 2.5   # Close 40% at 2.5R
  tp2_close_pct: 0.40
  runner_pct: 0.20      # Keep 20% as runner
  move_sl_to_be_after_tp1: true  # Auto move to breakeven after TP1
  trailing_stop_enabled: true    # Enable trailing for runner
  trailing_stop_atr_multiplier: 1.5

## Data Acquisition
data:
  # WebSocket settings
  ws_reconnect_max_retries: 10
  ws_reconnect_backoff_seconds: 5
  
  # Data validation
  max_gap_seconds: 60  # Alert if data gap > 1 minute

  # Candle health gate: pause new entries when below threshold
  # When universe size < min_healthy_coins, we require all coins to have sufficient candles (effective_min = min(30, total))
  min_healthy_coins: 30   # Min coins with >=50 bars 15m to allow new entries; small universes use min(30, total)
  min_health_ratio: 0.25  # Min fraction of universe that must have sufficient candles
  
  # Storage
  database_url: "${DATABASE_URL}"  # From environment variable

## Liquidity Filters (Market Discovery)
liquidity_filters:
  # Spot filters
  min_spot_volume_usd_24h: 1000000  # $1M minimum (relaxed from $5M)
  max_spread_pct: 0.0020  # 0.20% spot spread (relaxed from 0.05%)
  min_price_usd: 0.01  # Avoid dust coins
  
  # Futures-specific filters
  min_futures_open_interest: 500000  # $500k OI minimum
  max_futures_spread_pct: 0.0030  # 0.30% perp spread
  min_futures_volume_usd_24h: 500000  # $500k futures volume
  max_funding_rate_abs: 0.001  # 0.1% funding cap (absolute value)
  
  # Filter mode: "spot_and_futures" (both must pass), "futures_primary" (futures required, spot optional)
  filter_mode: "futures_primary"
  
  # Tier-specific risk limits (A=high liquidity, B=medium, C=low)
  tier_configs:
    A:  # High liquidity (BTC, ETH, SOL tier)
      max_leverage: 10.0
      max_position_size_usd: 100000
      slippage_cap_pct: 0.001
      allow_live_trading: true
    B:  # Medium liquidity
      max_leverage: 5.0
      max_position_size_usd: 50000
      slippage_cap_pct: 0.002
      allow_live_trading: true
    C:  # Lower liquidity (restricted)
      max_leverage: 2.0
      max_position_size_usd: 25000
      slippage_cap_pct: 0.003
      allow_live_trading: true
  
## Reconciliation
reconciliation:
  # Event-driven: immediate on fills, order updates, margin updates
  # Live: use >= 60 (prefer 120). 15s hammers Kraken combined with OHLCV/tickers/orders.
  periodic_interval_seconds: 120
  
## Monitoring
monitoring:
  # Logging
  log_level: "INFO"  # DEBUG/INFO/WARNING/ERROR/CRITICAL
  log_format: "text"  # text = human-readable one line per event; json = machine-parseable
  
  # Alerts
  alert_margin_usage_threshold_pct: 0.70  # 70%
  alert_liquidation_buffer_threshold_pct: 0.35  # Alert if < 35%
  alert_repeated_rejections_count: 3
  alert_repeated_rejections_window_seconds: 300
  
  # Alert delivery (configure as needed)
  alert_methods:
    - "log"  # Always log alerts
    # - "slack"
    # - "discord"
  # slack_webhook_url: "https://hooks.slack.com/..."
  # discord_webhook_url: "https://discord.com/api/webhooks/..."

## Backtesting
backtest:
  # Starting capital
  starting_equity: 10000  # $10,000 starting capital
  
  # Fill assumptions
  assume_maker_fills: true  # Assume limit orders fill at maker fee
  slippage_bps: 2  # 2 basis points average slippage
  
  # Cost modeling
  maker_fee_bps: 2  # Kraken Futures maker fee (check current rates)
  taker_fee_bps: 5  # Kraken Futures taker fee
  
  # Basis modeling
  basis_model: "static"  # static / stochastic
  static_basis_bps: 5  # 5 basis points static basis assumption

## Paper Trading
paper:
  # Simulation settings
  simulate_realistic_slippage: true
  simulate_fill_delays_ms: 100

## Live Trading
live:
  # Safety gates
  require_paper_success: true
  min_paper_days: 30
  min_paper_trades: 50
  max_paper_drawdown_pct: 0.15  # Paper must stay within 15% DD

## Coin Universe (V3 - Full Kraken Integration)
# Total: 249 coins available on both Spot and Futures
coin_universe:
  enabled: true
  min_spot_volume_24h: 1000000  # $1M minimum
  
  # Liquidity tiers (A = highest, B = medium, C = lower)
  liquidity_tiers:
    # Tier A: Top 20 major coins (20 coins)
    A:
      - "BTC/USD"  # Bitcoin (Spot uses BTC, Futures uses XBT)
      - "ETH/USD"
      - "SOL/USD"
      - "BNB/USD"
      - "XRP/USD"
      - "ADA/USD"
      - "AVAX/USD"
      - "DOT/USD"
      - "LINK/USD"
      - "UNI/USD"
      - "LTC/USD"
      - "BCH/USD"
      - "ATOM/USD"
      - "TON/USD"
      - "TRX/USD"
      - "ICP/USD"
      - "NEAR/USD"
      - "APT/USD"
      - "SUI/USD"
      - "OP/USD"

    # Tier B: Established altcoins (50 coins)
    B:
      - "ARB/USD"
      - "FIL/USD"
      - "IMX/USD"
      - "INJ/USD"
      - "TIA/USD"
      - "SEI/USD"
      - "AAVE/USD"
      - "SNX/USD"
      - "CRV/USD"
      - "LDO/USD"
      - "RENDER/USD"
      - "GRT/USD"
      - "SAND/USD"
      - "MANA/USD"
      - "AXS/USD"
      - "GALA/USD"
      - "ENJ/USD"
      - "CHZ/USD"
      - "FLOW/USD"
      - "EGLD/USD"
      - "XTZ/USD"
      - "ALGO/USD"
      - "DOGE/USD"
      - "ETC/USD"
      - "KAS/USD"
      - "FET/USD"
      - "HBAR/USD"
      - "VET/USD"
      - "XLM/USD"
      - "XMR/USD"
      - "ZEC/USD"
      - "DASH/USD"
      - "COMP/USD"
      - "YFI/USD"
      - "UMA/USD"
      - "BAT/USD"
      - "ZRX/USD"
      - "1INCH/USD"
      - "SUSHI/USD"
      - "DYDX/USD"
      - "GMX/USD"
      - "PERP/USD"
      - "RUNE/USD"
      - "KAVA/USD"
      - "CELO/USD"
      - "QTUM/USD"
      - "ICX/USD"
      - "ENS/USD"
      - "BLUR/USD"
      - "PENDLE/USD"
      - "ONDO/USD"

    # Tier C: Remaining coins (179 coins)
    C:
      - "2Z/USD"
      - "AEVO/USD"

      - "AIXBT/USD"
      - "AKT/USD"
      - "ALCH/USD"
      - "ALICE/USD"
      - "ALT/USD"
      - "ANIME/USD"
      - "ANKR/USD"
      - "APE/USD"
      - "API3/USD"
      - "AR/USD"
      - "ARC/USD"
      - "ARKM/USD"
      - "ASTER/USD"
      - "ASTR/USD"
      - "ATH/USD"
      - "AUCTION/USD"
      - "B3/USD"
      - "BAND/USD"
      - "BEAM/USD"
      - "BERA/USD"
      - "BICO/USD"
      - "BIGTIME/USD"
      - "BIO/USD"
      - "BNT/USD"
      - "BONK/USD"
      - "BSU/USD"
      - "C98/USD"
      - "CAKE/USD"
      - "CAT/USD"
      - "CELR/USD"
      - "CHR/USD"
      - "COOKIE/USD"
      - "COTI/USD"
      - "COW/USD"
      - "CRO/USD"
      - "CTSI/USD"
      - "CVX/USD"
      - "CYBER/USD"
      - "DEEP/USD"
      - "DEGEN/USD"
      - "DENT/USD"
      - "DOG/USD"
      - "DOGS/USD"
      - "DRIFT/USD"
      - "DYM/USD"
      - "EIGEN/USD"
      - "ENA/USD"
      - "ESPORTS/USD"
      - "ETHFI/USD"
      - "ETHW/USD"
      - "FARTCOIN/USD"
      - "FLOKI/USD"
      - "FLR/USD"
      - "FLUX/USD"
      - "FOLKS/USD"
      - "FXS/USD"
      - "G/USD"
      - "GIGA/USD"
      - "GMT/USD"
      - "GOAT/USD"
      - "GRASS/USD"
      - "GRIFFAIN/USD"
      - "GTC/USD"
      - "HFT/USD"
      - "HIPPO/USD"
      - "HMSTR/USD"
      - "INIT/USD"
      - "IP/USD"
      - "JASMY/USD"
      - "JTO/USD"
      - "JUP/USD"
      - "KAITO/USD"
      - "KSM/USD"
      - "LAYER/USD"
      - "LCAP/USD"
      - "LPT/USD"
      - "LQTY/USD"
      - "LRC/USD"
      - "LSK/USD"
      - "LUNA/USD"
      - "ME/USD"
      - "MELANIA/USD"
      - "METIS/USD"
      - "MEW/USD"
      - "MINA/USD"
      - "MIRA/USD"
      - "MNT/USD"
      - "MOG/USD"
      - "MON/USD"
      - "MOODENG/USD"
      - "MORPHO/USD"
      - "MOVE/USD"
      - "MOVR/USD"
      - "MUBARAK/USD"
      - "NEIRO/USD"
      - "NIGHT/USD"
      - "NMR/USD"
      - "NOT/USD"
      - "OGN/USD"
      - "OM/USD"
      - "OMI/USD"
      - "OPEN/USD"
      - "ORCA/USD"
      - "ORDER/USD"
      - "OXT/USD"
      - "PAXG/USD"
      - "PENGU/USD"
      - "PEPE/USD"
      - "PNUT/USD"
      - "POL/USD"
      - "PONKE/USD"
      - "POPCAT/USD"
      - "PORTAL/USD"
      - "POWR/USD"
      - "PRCL/USD"
      - "PROMPT/USD"
      - "PUMP/USD"
      - "PYTH/USD"
      - "QNT/USD"
      - "RARE/USD"
      - "RARI/USD"
      - "RAY/USD"
      - "REZ/USD"
      - "RLC/USD"
      - "RSR/USD"
      - "S/USD"
      - "SAGA/USD"
      - "SHIB/USD"
      - "SOLV/USD"
      - "SONIC/USD"
      - "SOON/USD"
      - "SPELL/USD"
      - "SPK/USD"
      - "SPX/USD"
      - "SSV/USD"
      - "STBL/USD"
      - "STG/USD"
      - "STORJ/USD"
      - "STRK/USD"
      - "STX/USD"
      - "SUN/USD"
      - "SUPER/USD"
      - "SWARMS/USD"
      - "SWELL/USD"
      - "SXT/USD"
      - "SYN/USD"
      - "SYRUP/USD"
      - "T/USD"
      - "TAO/USD"
      - "TLM/USD"
      - "TNSR/USD"
      - "TOKEN/USD"
      - "TOSHI/USD"
      - "TRU/USD"
      - "TRUMP/USD"
      - "TURBO/USD"
      - "USUAL/USD"
      - "VINE/USD"
      - "VIRTUAL/USD"
      - "W/USD"
      - "WIF/USD"
      - "WLD/USD"
      - "WLFI/USD"
      - "WOO/USD"
      - "XAUT/USD"
      - "XCN/USD"
      - "XPL/USD"
      - "YGG/USD"
      - "ZBT/USD"
      - "ZEREBRO/USD"
      - "ZETA/USD"
      - "ZK/USD"
      - "ZRO/USD"

  # Max leverage per tier (respects global 10x cap)
  tier_max_leverage:
    A: 10.0
    B: 7.0
    C: 5.0

## Environment
environment: "prod"  # LIVE TRADING MODE - REAL CAPITAL AT RISK
