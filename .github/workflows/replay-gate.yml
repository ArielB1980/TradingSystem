# Replay Harness CI Gate
#
# Runs the full 6-episode replay suite on every PR that touches
# critical trading/safety code. Fails the PR if any episode fails.
#
# Trigger paths: execution, risk, safety, client, health monitor,
# kill switch, live trading, circuit breaker.

name: Replay Safety Gate

on:
  pull_request:
    paths:
      - 'src/execution/**'
      - 'src/risk/**'
      - 'src/safety/**'
      - 'src/data/kraken_client.py'
      - 'src/live/**'
      - 'src/utils/circuit_breaker.py'
      - 'src/utils/kill_switch.py'
      - 'src/tools/safety_reset.py'
      - 'src/backtest/replay_harness/**'
    branches: [main]

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests
        env:
          ENV: local
          DATABASE_URL: "sqlite:///./tests/.test_db.sqlite"
        run: |
          python -m pytest tests/unit/ -v --tb=short -q

  replay-gate:
    name: Replay Safety Gate
    runs-on: ubuntu-latest
    needs: unit-tests
    strategy:
      matrix:
        seed: [42, 1, 7]  # Run with 3 jitter seeds for robustness
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run replay episodes (seed=${{ matrix.seed }})
        env:
          ENV: local
          DRY_RUN: "0"
          DATABASE_URL: "sqlite:///./tests/.test_db.sqlite"
        run: |
          python -m src.backtest.replay_harness.run_episodes \
            --seed ${{ matrix.seed }} \
            --data-dir data/replay \
            --output results/replay/seed-${{ matrix.seed }}

      - name: Upload replay results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: replay-results-seed-${{ matrix.seed }}
          path: results/replay/seed-${{ matrix.seed }}/
          retention-days: 14
